name: DevOps AI Deploy

on:
  push:
    branches: [ "main" ]

env:
  AWS_REGION: us-east-1
  EC2_INSTANCE_TYPE: t3.micro
  IMAGE_NAME: devops-ai-demo

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build Docker image
        run: |
          docker build -t $IMAGE_NAME .

      - name: Create ECR repository if missing
        run: |
          aws ecr describe-repositories --repository-names $IMAGE_NAME || \
          aws ecr create-repository --repository-name $IMAGE_NAME

      - name: Push image to ECR
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URI=$ACCOUNT_ID.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/$IMAGE_NAME
          docker tag $IMAGE_NAME:latest $ECR_URI:latest
          docker push $ECR_URI:latest
          echo "ECR_URI=$ECR_URI" >> $GITHUB_ENV

      - name: Launch or reuse EC2 instance
        id: ec2
        run: |
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=github-devops-instance" \
                      "Name=instance-state-name,Values=running" \
            --query "Reservations[0].Instances[0].InstanceId" \
            --output text)

          if [ "$INSTANCE_ID" = "None" ]; then
            echo "Launching new EC2 instance..."
            INSTANCE_ID=$(aws ec2 run-instances \
              --image-id ami-0e86e20dae9224db8 \
              --instance-type ${{ env.EC2_INSTANCE_TYPE }} \
              --iam-instance-profile Name=EC2ECRAccessRole \
              --security-group-ids sg-05a41bf291232115e \
              --subnet-id subnet-0bc8bd98802435140 \
              --user-data '#!/bin/bash
                yum update -y
                yum install -y docker
                systemctl start docker
                systemctl enable docker' \
              --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=github-devops-instance}]' \
              --query "Instances[0].InstanceId" \
              --output text)
            echo "New instance launched: $INSTANCE_ID"
          else
            echo "Reusing instance: $INSTANCE_ID"
          fi

          echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_ENV

      - name: Get EC2 Public IP
        id: ec2-ip
        run: |
          PUBLIC_IP=$(aws ec2 describe-instances \
            --instance-ids $INSTANCE_ID \
            --query "Reservations[0].Instances[0].PublicIpAddress" \
            --output text)
          echo "EC2_IP=$PUBLIC_IP" >> $GITHUB_ENV
          echo "Public IP: $PUBLIC_IP"

      - name: Deploy container on EC2
        uses: appleboy/ssh-action@v1.1.0
        with:
          host: ${{ env.EC2_IP }}
          username: ec2-user
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            sudo docker stop devops-ai-demo || true
            sudo docker rm devops-ai-demo || true
            sudo docker pull $ECR_URI:latest
            sudo docker run -d --name devops-ai-demo -p 80:80 \
              -e OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }} \
              $ECR_URI:latest

      - name: Wait for app to be ready
        run: |
          echo "Waiting for app on EC2..."
          sleep 30
          echo "App should be available soon at: http://${{ env.EC2_IP }}/"

      - name: Test AI endpoint
        run: |
          curl -X POST -H "Content-Type: application/json" \
            -d '{"text":"This pipeline is awesome!"}' \
            http://${{ env.EC2_IP }}/predict || exit 1

      - name: Optional AI Review (OpenAI)
        if: ${{ secrets.OPENAI_API_KEY != '' }}
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "Running AI code review..."
          curl https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d '{
              "model": "gpt-4o-mini",
              "messages": [
                {"role": "system", "content": "You are an AI DevOps reviewer."},
                {"role": "user", "content": "Analyze this deployment YAML for best practices."}
              ]
            }' | jq '.choices[0].message.content'

      - name: Deployment finished
        run: echo "Deployment complete! Access app at: http://${{ env.EC2_IP }}/"
