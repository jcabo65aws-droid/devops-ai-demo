name: DevOps AI Pipeline

on:
  push:
    branches:
      - main

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1
      ECR_REPO: devops-ai-demo
      INSTANCE_NAME: github-devops-instance

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Amazon ECR
        run: |
          echo "Logging in to Amazon ECR..."
          aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin ${{ env.ECR_REPO }}.dkr.ecr.$AWS_REGION.amazonaws.com

      - name: Build Docker image
        run: |
          echo "Building Docker image..."
          docker build -t $ECR_REPO:latest .

      - name: AI Code Review (OpenAI)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "‚ö†Ô∏è  No OpenAI API key provided, skipping AI analysis."
            exit 0
          fi

          echo "üß† Running AI Code Review..."
          DOCKER_FILE_CONTENT=$(sed -n '1,100p' Dockerfile || echo "No Dockerfile found.")
          PROMPT=$(echo "You are a senior DevOps engineer. Review this Dockerfile for best practices, security issues, and improvement suggestions:\n\n$DOCKER_FILE_CONTENT")

          JSON=$(jq -n --arg prompt "$PROMPT" '{
            model: "gpt-4o-mini",
            messages: [
              {"role": "system", "content": "You are a helpful AI DevOps assistant."},
              {"role": "user", "content": $prompt}
            ],
            max_tokens: 600
          }')

          curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$JSON" | jq -r '.choices[0].message.content'

      - name: Deploy to EC2
        run: |
          echo "üöÄ Creating EC2 instance..."
          AMI_ID=ami-0c94855ba95c71c99   # Amazon Linux 2 (us-east-1)
          INSTANCE_TYPE=t2.micro
          KEY_NAME=MyKeyPair
          SECURITY_GROUP_ID=sg-0123456789abcdef0  # <--- reemplaza por tu SG real
          SUBNET_ID=subnet-0123456789abcdef0      # <--- reemplaza por tu Subnet real

          aws ec2 run-instances \
            --image-id $AMI_ID \
            --instance-type $INSTANCE_TYPE \
            --key-name $KEY_NAME \
            --security-group-ids $SECURITY_GROUP_ID \
            --subnet-id $SUBNET_ID \
            --region $AWS_REGION \
            --tag-specifications "ResourceType=instance,Tags=[{Key=Name,Value=${INSTANCE_NAME}}]"

          echo "‚úÖ EC2 instance creation requested successfully."
