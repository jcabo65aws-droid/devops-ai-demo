name: DevOps AI Pipeline

on:
  push:
    branches:
      - main

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    env:
      ECR_REPO: devops-ai-demo
      INSTANCE_NAME: github-devops-instance

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Amazon ECR
        env:
          AWS_REGION: us-east-1
        run: |
          aws --version
          echo "Logging in to ECR..."
          aws ecr get-login-password --region $AWS_REGION | docker login --username AWS --password-stdin ${{ env.ECR_REPO }}.dkr.ecr.$AWS_REGION.amazonaws.com

      - name: Build Docker image
        run: |
          docker build -t $ECR_REPO:latest .

      - name: AI Code Review (OpenAI)
        if: ${{ secrets.OPENAI_API_KEY != '' }}
        run: |
          echo "Running AI Code Review..."
          DOCKER_FILE_CONTENT=$(sed -n '1,100p' Dockerfile || echo "No Dockerfile")
          PROMPT=$(echo "You are a senior DevOps engineer. Review the following Dockerfile for best practices, security issues, and suggestions:\n\n$DOCKER_FILE_CONTENT")

          JSON=$(jq -n --arg prompt "$PROMPT" '{
            model: "gpt-5",
            messages: [
              {"role": "system", "content": "
