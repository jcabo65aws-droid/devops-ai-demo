name: DevOps AI Pipeline

on:
  push:
    branches:
      - main

jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: us-east-1
      ECR_REPO: devops-ai-demo
      INSTANCE_NAME: github-devops-instance

    steps:
      # 1Ô∏è‚É£ Descarga el c√≥digo del repositorio
      - name: Checkout code
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Configura las credenciales de AWS
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 3Ô∏è‚É£ Configura Docker Buildx
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # 4Ô∏è‚É£ Login en ECR
     - name: Ensure ECR repo exists and log in
     run: |
      echo "üîç Checking if ECR repository exists..."
      REPO_NAME=${{ env.ECR_REPO }}
      REGION=${{ env.AWS_REGION }}

      if ! aws ecr describe-repositories --repository-names "$REPO_NAME" --region "$REGION" >/dev/null 2>&1; then
        echo "ü™Ñ Repository not found. Creating ECR repository: $REPO_NAME ..."
        aws ecr create-repository --repository-name "$REPO_NAME" --region "$REGION"
        echo "‚úÖ Repository created successfully."
      else
       echo "‚úÖ Repository already exists."
      fi

      echo "üîë Logging in to Amazon ECR..."
      aws ecr get-login-password --region "$REGION" | docker login --username AWS --password-stdin "${ACCOUNT_ID}.dkr.ecr.${REGION}.amazonaws.com"

      # 5Ô∏è‚É£ Construye la imagen Docker
      - name: Build Docker image
        run: |
          echo "üê≥ Building Docker image..."
          docker build -t $ECR_REPO:latest .

      # 6Ô∏è‚É£ An√°lisis de c√≥digo con IA (OpenAI)
      - name: AI Code Review (OpenAI)
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "‚ö†Ô∏è  No OpenAI API key provided, skipping AI analysis."
            exit 0
          fi

          echo "ü§ñ Running AI Code Review..."
          DOCKER_FILE_CONTENT=$(sed -n '1,100p' Dockerfile || echo "No Dockerfile found.")
          PROMPT=$(echo "You are a senior DevOps engineer. Review this Dockerfile for best practices, security issues, and improvement suggestions:\n\n$DOCKER_FILE_CONTENT")

          JSON=$(jq -n --arg prompt "$PROMPT" '{
            model: "gpt-4o-mini",
            messages: [
              {"role": "system", "content": "You are a helpful AI DevOps assistant."},
              {"role": "user", "content": $prompt}
            ],
            max_tokens: 600
          }')

          curl -s https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d "$JSON" | jq -r '.choices[0].message.content'

      # 7Ô∏è‚É£ Crea una instancia EC2
      - name: Deploy to EC2
        run: |
          echo "üöÄ Creating EC2 instance..."
          AMI_ID=ami-0c94855ba95c71c99   # Amazon Linux 2 (us-east-1)
          INSTANCE_TYPE=t2.micro
          KEY_NAME=MyKeyPair
          SECURITY_GROUP_ID=sg-0123456789abcdef0  # <-- reemplaza por tu SG real
          SUBNET_ID=subnet-0123456789abcdef0      # <-- reemplaza por tu Subnet real

          INSTANCE_ID=$(aws ec2 run-instances \
            --image-id $AMI_ID \
            --instance-type $INSTANCE_TYPE \
            --key-name $KEY_NAME \
            --security-group-ids $SECURITY_GROUP_ID \
            --subnet-id $SUBNET_ID \
            --region $AWS_REGION \
            --tag-specifications "ResourceType=instance,Tags=[{Key=Name,Value=${INSTANCE_NAME}}]" \
            --query "Instances[0].InstanceId" \
            --output text)

          echo "‚úÖ EC2 instance created: $INSTANCE_ID"

          echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_ENV

      # 8Ô∏è‚É£ Espera y despliega el contenedor autom√°ticamente
      - name: Configure and deploy container on EC2
        env:
          AWS_REGION: ${{ env.AWS_REGION }}
          INSTANCE_NAME: ${{ env.INSTANCE_NAME }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          echo "‚öôÔ∏è Waiting for EC2 instance to be ready..."
          INSTANCE_ID=${INSTANCE_ID:-$(aws ec2 describe-instances --filters "Name=tag:Name,Values=${INSTANCE_NAME}" \
            --query "Reservations[].Instances[].InstanceId" --output text --region $AWS_REGION)}

          aws ec2 wait instance-running --instance-ids $INSTANCE_ID --region $AWS_REGION
          echo "‚úÖ EC2 instance is now running."

          PUBLIC_IP=$(aws ec2 describe-instances --instance-ids $INSTANCE_ID \
            --query "Reservations[].Instances[].PublicIpAddress" --output text --region $AWS_REGION)
          echo "üåç Public IP: $PUBLIC_IP"

          echo "üóùÔ∏è Creating temporary SSH key file..."
          echo "$EC2_SSH_KEY" > MyKeyPair.pem
          chmod 400 MyKeyPair.pem

          echo "üîß Installing Docker and starting container..."
          ssh -o StrictHostKeyChecking=no -i MyKeyPair.pem ec2-user@$PUBLIC_IP << 'EOF'
            sudo yum update -y
            sudo yum install docker -y
            sudo systemctl start docker
            sudo systemctl enable docker
            docker run -d -p 80:80 nginx:stable
          EOF

          echo "‚úÖ Container deployed successfully on EC2."
          echo "üåê Visit: http://$PUBLIC_IP"
