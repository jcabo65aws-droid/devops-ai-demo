name: Deploy AI Demo (EC2 + Docker)

on:
  push:
    branches: [ main ]

env:
  IMAGE_NAME: ai-demo
  CONTAINER_NAME: ai-demo

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Compute tag
        id: meta
        run: echo "TAG=${GITHUB_SHA::7}" >> $GITHUB_OUTPUT

      - name: Login to Docker Hub
        run: echo "${{ secrets.DOCKERHUB_TOKEN }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build image
        run: |
          REPO="${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}"
          docker build -t "$REPO:${{ steps.meta.outputs.TAG }}" -t "$REPO:latest" .

      - name: Push image
        run: |
          REPO="${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}"
          docker push "$REPO:${{ steps.meta.outputs.TAG }}"
          docker push "$REPO:latest"

      - name: SSH redeploy on EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop: true
          script: |
            set -e
            if ! command -v docker >/dev/null 2>&1; then
              sudo dnf update -y || sudo yum update -y
              if command -v dnf >/dev/null 2>&1; then
                sudo dnf install -y docker
              else
                sudo yum install -y docker
              fi
              sudo systemctl enable --now docker
              sudo usermod -aG docker "$USER" || true
            fi
            sudo systemctl start docker || true
            REPO="${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}"
            sudo docker pull "$REPO:latest"
            sudo docker rm -f "${{ env.CONTAINER_NAME }}" || true
            sudo docker run -d --name "${{ env.CONTAINER_NAME }}" -p 80:8080 "$REPO:latest"
