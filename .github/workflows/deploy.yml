name: DevOps AI Deploy

on:
  push:
    branches: [ "main" ]

env:
  AWS_REGION: us-east-1
  EC2_INSTANCE_TYPE: t3.micro
  IMAGE_NAME: devops-ai-demo
  INSTANCE_NAME: github-devops-instance

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Checkout del repositorio
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Configurar credenciales AWS
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # 3Ô∏è‚É£ Login a Amazon ECR
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      # 4Ô∏è‚É£ Construir la imagen Docker
      - name: Build Docker image
        run: |
          docker build -t $IMAGE_NAME .

      # 5Ô∏è‚É£ Crear repositorio ECR si no existe
      - name: Create ECR repository if missing
        run: |
          aws ecr describe-repositories --repository-names $IMAGE_NAME || \
          aws ecr create-repository --repository-name $IMAGE_NAME

      # 6Ô∏è‚É£ Publicar imagen en ECR
      - name: Push image to ECR
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URI=$ACCOUNT_ID.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/$IMAGE_NAME
          docker tag $IMAGE_NAME:latest $ECR_URI:latest
          docker push $ECR_URI:latest
          echo "ECR_URI=$ECR_URI" >> $GITHUB_ENV

      # 7Ô∏è‚É£ Lanzar o reutilizar instancia EC2
      - name: Launch or reuse EC2 instance
        id: ec2
        run: |
          ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_URI=$ACCOUNT_ID.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.IMAGE_NAME }}

          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=${{ env.INSTANCE_NAME }}" \
                      "Name=instance-state-name,Values=running" \
            --query "Reservations[0].Instances[0].InstanceId" \
            --output text)

          if [ "$INSTANCE_ID" = "None" ]; then
            echo "üöÄ Launching new EC2 instance..."
            INSTANCE_ID=$(aws ec2 run-instances \
              --image-id ami-0e86e20dae9224db8 \
              --instance-type ${{ env.EC2_INSTANCE_TYPE }} \
              --iam-instance-profile Name=EC2ECRAccessRole \
              --security-group-ids sg-05a41bf291232115e \
              --subnet-id subnet-0bc8bd98802435140 \
              --user-data "#!/bin/bash
                yum update -y
                yum install -y docker aws-cli
                systemctl enable docker
                systemctl start docker
                ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
                ECR_URI=$ACCOUNT_ID.dkr.ecr.${{ env.AWS_REGION }}.amazonaws.com/${{ env.IMAGE_NAME }}
                aws ecr get-login-password --region ${{ env.AWS_REGION }} | docker login --username AWS --password-stdin $ECR_URI
                docker pull $ECR_URI:latest
                docker run -d -p 80:80 --name devops-ai-demo -e OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }} $ECR_URI:latest" \
              --tag-specifications 'ResourceType=instance,Tags=[{Key=Name,Value=${{ env.INSTANCE_NAME }}}]' \
              --query "Instances[0].InstanceId" \
              --output text)
            echo "‚úÖ New instance launched: $INSTANCE_ID"
          else
            echo "‚ôªÔ∏è Reusing existing instance: $INSTANCE_ID"
          fi

          echo "INSTANCE_ID=$INSTANCE_ID" >> $GITHUB_ENV

      # 8Ô∏è‚É£ Obtener IP p√∫blica
      - name: Get EC2 Public IP
        id: ec2-ip
        run: |
          aws ec2 wait instance-running --instance-ids $INSTANCE_ID
          PUBLIC_IP=$(aws ec2 describe-instances \
            --instance-ids $INSTANCE_ID \
            --query "Reservations[0].Instances[0].PublicIpAddress" \
            --output text)
          echo "EC2_IP=$PUBLIC_IP" >> $GITHUB_ENV
          echo "üåç EC2 Public IP: $PUBLIC_IP"

      # 9Ô∏è‚É£ Esperar despliegue y probar endpoint
      - name: Wait for app to start
        run: |
          echo "‚è≥ Waiting 60s for the app to initialize..."
          sleep 60
          echo "Checking if app responds..."
          curl -I http://${{ env.EC2_IP }} || echo "App not responding yet."

      # üîü Test AI endpoint
      - name: Test AI endpoint
        run: |
          echo "üß† Testing AI endpoint..."
          curl -X POST -H "Content-Type: application/json" \
            -d '{"text":"Hello AI!"}' \
            http://${{ env.EC2_IP }}/predict || echo "‚ö†Ô∏è AI endpoint not ready"

      # 1Ô∏è‚É£1Ô∏è‚É£ Revisi√≥n de c√≥digo por IA
      - name: Optional AI Review
        if: always()
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "$OPENAI_API_KEY" ]; then
            echo "‚ö†Ô∏è No OpenAI API key found. Skipping review."
            exit 0
          fi
          echo "ü§ñ Running AI code review..."
          curl https://api.openai.com/v1/chat/completions \
            -H "Content-Type: application/json" \
            -H "Authorization: Bearer $OPENAI_API_KEY" \
            -d '{
              "model": "gpt-4o-mini",
              "messages": [
                {"role": "system", "content": "You are an AI DevOps reviewer."},
                {"role": "user", "content": "Analyze this pipeline YAML for best practices."}
              ]
            }' | jq -r '.choices[0].message.content'

      # 1Ô∏è‚É£2Ô∏è‚É£ Finalizaci√≥n
      - name: Deployment finished
        run: |
          echo "üéâ Deployment complete!"
          echo "Access app at: http://${{ env.EC2_IP }}/"
